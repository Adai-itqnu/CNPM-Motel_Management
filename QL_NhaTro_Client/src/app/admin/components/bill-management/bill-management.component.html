<div class="bill-management">
  <!-- Page Header with Actions -->
  <div class="page-header">
    <div class="header-left">
      <h1>Qu·∫£n L√Ω H√≥a ƒê∆°n</h1>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="openGenerateModal()">
        <span>‚ö°</span> T·∫°o H√≥a ƒê∆°n Th√°ng
      </button>
    </div>
  </div>



  <!-- Loading -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i...</p>
  </div>

  <!-- Monthly Bills Tab -->
  <div class="tab-content" *ngIf="!isLoading && activeTab === 'monthly'">
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Th√°ng:</label>
        <select [(ngModel)]="filterMonth">
          <option [value]="0">T·∫•t c·∫£</option>
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">Th√°ng {{ m }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>NƒÉm:</label>
        <select [(ngModel)]="filterYear">
          <option [value]="2024">2024</option>
          <option [value]="2025">2025</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i:</label>
        <select [(ngModel)]="filterStatus">
          <option value="all">T·∫•t c·∫£</option>
          <option value="Pending">Ch∆∞a thanh to√°n</option>
          <option value="Paid">ƒê√£ thanh to√°n</option>
          <option value="Overdue">Qu√° h·∫°n</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ƒê√£ g·ª≠i:</label>
        <select [(ngModel)]="filterSent">
          <option value="all">T·∫•t c·∫£</option>
          <option value="sent">ƒê√£ g·ª≠i</option>
          <option value="unsent">Ch∆∞a g·ª≠i</option>
        </select>
      </div>
    </div>

    <!-- Bills Table -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Ph√≤ng</th>
            <th>Kh√°ch thu√™</th>
            <th>K·ª≥</th>
            <th>ƒêi·ªán (kWh)</th>
            <th>N∆∞·ªõc (m¬≥)</th>
            <th>Ti·ªÅn ph√≤ng</th>
            <th>T·ªïng</th>
            <th>Tr·∫°ng th√°i</th>
            <th>ƒê√£ g·ª≠i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bill of filteredBills">
            <td class="room-name">{{ bill.roomName }}</td>
            <td>{{ bill.userName }}</td>
            <td>{{ bill.month }}/{{ bill.year }}</td>
            <td>
              <span *ngIf="bill.electricityNewIndex > 0">
                {{ bill.electricityOldIndex }} ‚Üí {{ bill.electricityNewIndex }}
                <small>({{ bill.electricityNewIndex - bill.electricityOldIndex }})</small>
              </span>
              <span *ngIf="bill.electricityNewIndex === 0" class="text-muted">Ch∆∞a nh·∫≠p</span>
            </td>
            <td>
              <span *ngIf="bill.waterNewIndex > 0">
                {{ bill.waterOldIndex }} ‚Üí {{ bill.waterNewIndex }}
                <small>({{ bill.waterNewIndex - bill.waterOldIndex }})</small>
              </span>
              <span *ngIf="bill.waterNewIndex === 0" class="text-muted">Ch∆∞a nh·∫≠p</span>
            </td>
            <td>
              {{ formatCurrency(bill.roomPrice) }}
              <small *ngIf="bill.daysRented < bill.daysInMonth" class="pro-rata">
                ({{ bill.daysRented }}/{{ bill.daysInMonth }} ng√†y)
              </small>
            </td>
            <td class="total-amount">{{ formatCurrency(bill.totalAmount) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(bill.status)">
                {{ getStatusLabel(bill.status) }}
              </span>
            </td>
            <td>
              <span class="sent-badge" [class.sent]="bill.isSent">
                {{ bill.isSent ? '‚úì ƒê√£ g·ª≠i' : '‚óã Ch∆∞a g·ª≠i' }}
              </span>
            </td>
            <td class="actions">
              <button 
                class="btn-action btn-edit" 
                (click)="openUpdateMetersModal(bill)"
                title="C·∫≠p nh·∫≠t ch·ªâ s·ªë">
                ‚úèÔ∏è
              </button>
              <button 
                class="btn-action btn-send" 
                *ngIf="!bill.isSent && bill.electricityNewIndex > 0"
                (click)="sendBillToTenant(bill)"
                title="G·ª≠i h√≥a ƒë∆°n">
                üì§
              </button>
              <button 
                class="btn-action btn-paid" 
                *ngIf="bill.status === 'Pending' && bill.isSent"
                (click)="updateBillStatus(bill, 'Paid')"
                title="ƒê√°nh d·∫•u ƒë√£ thanh to√°n">
                ‚úì
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="empty-state" *ngIf="filteredBills.length === 0">
        <p>Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o. Nh·∫•n "T·∫°o H√≥a ƒê∆°n Th√°ng" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
      </div>
    </div>
  </div>

</div>

<!-- Generate Bills Modal -->
<div class="modal-overlay" *ngIf="showGenerateModal" (click)="closeGenerateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ö° T·∫°o H√≥a ƒê∆°n H√†ng Th√°ng</h2>
      <button class="close-btn" (click)="closeGenerateModal()">√ó</button>
    </div>
    <div class="modal-body">
      <p class="modal-description">
        H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o h√≥a ƒë∆°n cho t·∫•t c·∫£ h·ª£p ƒë·ªìng ƒëang ho·∫°t ƒë·ªông.
        Ti·ªÅn ph√≤ng s·∫Ω ƒë∆∞·ª£c t√≠nh pro-rata theo s·ªë ng√†y ·ªü.
      </p>
      <div class="form-group">
        <label>Th√°ng</label>
        <select [(ngModel)]="generateMonth">
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">Th√°ng {{ m }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>NƒÉm</label>
        <select [(ngModel)]="generateYear">
          <option [value]="2024">2024</option>
          <option [value]="2025">2025</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeGenerateModal()">H·ªßy</button>
      <button class="btn-primary" (click)="generateBills()" [disabled]="isGenerating">
        {{ isGenerating ? 'ƒêang t·∫°o...' : 'T·∫°o H√≥a ƒê∆°n' }}
      </button>
    </div>
  </div>
</div>

<!-- Update Meters Modal -->
<div class="modal-overlay" *ngIf="showUpdateModal" (click)="closeUpdateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚úèÔ∏è C·∫≠p Nh·∫≠t Ch·ªâ S·ªë ƒêi·ªán N∆∞·ªõc</h2>
      <button class="close-btn" (click)="closeUpdateModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedBill">
      <div class="bill-info">
        <p><strong>Ph√≤ng:</strong> {{ selectedBill.roomName }}</p>
        <p><strong>Kh√°ch thu√™:</strong> {{ selectedBill.userName }}</p>
        <p><strong>K·ª≥:</strong> Th√°ng {{ selectedBill.month }}/{{ selectedBill.year }}</p>
      </div>
      
      <div class="meter-section">
        <h3>‚ö° ƒêi·ªán</h3>
        <div class="meter-row">
          <div class="form-group">
            <label>Ch·ªâ s·ªë c≈©</label>
            <input type="number" [value]="selectedBill.electricityOldIndex" disabled>
          </div>
          <div class="form-group">
            <label>Ch·ªâ s·ªë m·ªõi</label>
            <input type="number" [(ngModel)]="updateMeters.electricityNewIndex" min="0">
          </div>
          <div class="form-group">
            <label>S·ªë ƒëi·ªán</label>
            <input type="text" [value]="updateMeters.electricityNewIndex - selectedBill.electricityOldIndex" disabled>
          </div>
        </div>
        <p class="price-info">ƒê∆°n gi√°: {{ formatCurrency(selectedBill.electricityPrice) }}/kWh</p>
      </div>

      <div class="meter-section">
        <h3>üíß N∆∞·ªõc</h3>
        <div class="meter-row">
          <div class="form-group">
            <label>Ch·ªâ s·ªë c≈©</label>
            <input type="number" [value]="selectedBill.waterOldIndex" disabled>
          </div>
          <div class="form-group">
            <label>Ch·ªâ s·ªë m·ªõi</label>
            <input type="number" [(ngModel)]="updateMeters.waterNewIndex" min="0">
          </div>
          <div class="form-group">
            <label>S·ªë n∆∞·ªõc</label>
            <input type="text" [value]="updateMeters.waterNewIndex - selectedBill.waterOldIndex" disabled>
          </div>
        </div>
        <p class="price-info">ƒê∆°n gi√°: {{ formatCurrency(selectedBill.waterPrice) }}/m¬≥</p>
      </div>

      <div class="meter-section">
        <h3>üìù Ph√≠ kh√°c</h3>
        <div class="form-group">
          <label>Ph√≠ ph√°t sinh (VNƒê)</label>
          <input type="number" [(ngModel)]="updateMeters.otherFees" min="0">
        </div>
        <div class="form-group">
          <label>Ghi ch√∫</label>
          <textarea [(ngModel)]="updateMeters.notes" rows="2"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeUpdateModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveMeters()" [disabled]="isUpdating">
        {{ isUpdating ? 'ƒêang l∆∞u...' : 'L∆∞u Ch·ªâ S·ªë' }}
      </button>
    </div>
  </div>
</div>