<div class="room-management">
  <div class="page-header">
    <h1>Qu·∫£n L√Ω Ph√≤ng</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span>+</span> Th√™m Ph√≤ng M·ªõi
    </button>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchText"
        placeholder="T√¨m ki·∫øm theo t√™n ph√≤ng..."
        (keyup.enter)="loadRooms()"
      />
      <button (click)="loadRooms()">üîç T√¨m</button>
    </div>
  </div>

  <!-- Message -->
  <div *ngIf="message" class="alert" [class.alert-error]="message.includes('L·ªói')">
    {{ message }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">ƒêang t·∫£i...</div>

  <!-- Room List -->
  <div class="room-grid" *ngIf="!loading">
    <div class="room-card" *ngFor="let room of rooms">
      <div class="room-image">
        <img
          [src]="
            room.images && room.images.length > 0
              ? 'http://localhost:5001' + room.images[0].imageUrl
              : 'https://via.placeholder.com/400x300?text=No+Image'
          "
          [alt]="room.name"
          onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"
        />
        <span class="room-status" [ngClass]="getStatusBadgeClass(room.status)">
          {{ getStatusText(room.status) }}
        </span>
      </div>

      <div class="room-info">
        <h3>{{ room.name }}</h3>
        <p class="room-type">{{ room.roomType || 'Ph√≤ng tr·ªç' }}</p>
        <p class="room-price">{{ room.price | number }}ƒë/th√°ng</p>
        <p class="room-details">üìç T·∫ßng {{ room.floor }} | üìê {{ room.area }}m¬≤</p>
        <div class="room-amenities">
          <span *ngFor="let amenity of room.amenities.slice(0, 3)" class="amenity-tag">
            {{ amenity }}
          </span>
          <span *ngIf="room.amenities.length > 3" class="amenity-tag">
            +{{ room.amenities.length - 3 }}
          </span>
        </div>
      </div>

      <div class="room-actions">
        <button class="btn-view" (click)="openViewModal(room)">üëÅÔ∏è Xem</button>
        <button class="btn-edit" (click)="openEditModal(room)">‚úèÔ∏è S·ª≠a</button>
        <button class="btn-delete" (click)="deleteRoom(room)">üóëÔ∏è X√≥a</button>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="rooms.length === 0" class="empty-state">
      <p>Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">‚Üê Tr∆∞·ªõc</button>

    <span>Trang {{ currentPage }} / {{ totalPages }}</span>

    <button [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
      Sau ‚Üí
    </button>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 *ngIf="modalMode === 'create'">Th√™m Ph√≤ng M·ªõi</h2>
      <h2 *ngIf="modalMode === 'edit'">Ch·ªânh S·ª≠a Ph√≤ng</h2>
      <h2 *ngIf="modalMode === 'view'">Chi Ti·∫øt Ph√≤ng</h2>
      <button class="btn-close" (click)="closeModal()">‚úñ</button>
    </div>

    <div class="modal-body">
      <!-- View Mode -->
      <div *ngIf="modalMode === 'view' && selectedRoom">
        <div class="detail-row"><strong>T√™n ph√≤ng:</strong> {{ selectedRoom.name }}</div>
        <div class="detail-row"><strong>Lo·∫°i ph√≤ng:</strong> {{ selectedRoom.roomType }}</div>
        <div class="detail-row"><strong>Gi√°:</strong> {{ selectedRoom.price | number }}ƒë/th√°ng</div>
        <div class="detail-row">
          <strong>Ti·ªÅn c·ªçc:</strong> {{ selectedRoom.depositAmount | number }}ƒë
        </div>
        <div class="detail-row">
          <strong>Gi√° ƒëi·ªán:</strong> {{ selectedRoom.electricityPrice | number }}ƒë/kWh
        </div>
        <div class="detail-row">
          <strong>Gi√° n∆∞·ªõc:</strong> {{ selectedRoom.waterPrice | number }}ƒë/m¬≥
        </div>
        <div class="detail-row"><strong>Di·ªán t√≠ch:</strong> {{ selectedRoom.area }}m¬≤</div>
        <div class="detail-row"><strong>T·∫ßng:</strong> {{ selectedRoom.floor }}</div>
        <div class="detail-row">
          <strong>Tr·∫°ng th√°i:</strong> {{ getStatusText(selectedRoom.status) }}
        </div>
        <div class="detail-row">
          <strong>M√¥ t·∫£:</strong> {{ selectedRoom.description || 'Kh√¥ng c√≥' }}
        </div>
        <div class="detail-row">
          <strong>Ti·ªán √≠ch:</strong>
          <div class="amenities-list">
            <span *ngFor="let amenity of selectedRoom.amenities" class="amenity-tag">
              {{ amenity }}
            </span>
          </div>
        </div>
      </div>

      <!-- Create/Edit Form -->
      <form *ngIf="modalMode !== 'view'" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label>T√™n ph√≤ng *</label>
          <input type="text" [(ngModel)]="roomForm.name" name="name" required />
        </div>

        <div class="form-group">
          <label>Lo·∫°i ph√≤ng *</label>
          <select [(ngModel)]="roomForm.roomType" name="roomType" required>
            <option value="">-- Ch·ªçn lo·∫°i ph√≤ng --</option>
            <option *ngFor="let type of roomTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Gi√° thu√™ *</label>
            <input
              type="number"
              [(ngModel)]="roomForm.price"
              name="price"
              required
              (ngModelChange)="onPriceChange($event)"
            />
          </div>

          <div class="form-group">
            <label>Ti·ªÅn c·ªçc (m·∫∑c ƒë·ªãnh = gi√° thu√™)</label>
            <input
              type="number"
              [(ngModel)]="roomForm.depositAmount"
              name="depositAmount"
              [placeholder]="'M·∫∑c ƒë·ªãnh: ' + roomForm.price"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Gi√° ƒëi·ªán (ƒë/kWh)</label>
            <input type="number" [(ngModel)]="roomForm.electricityPrice" name="electricityPrice" />
          </div>

          <div class="form-group">
            <label>Gi√° n∆∞·ªõc (ƒë/m¬≥)</label>
            <input type="number" [(ngModel)]="roomForm.waterPrice" name="waterPrice" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Di·ªán t√≠ch (m¬≤)</label>
            <input type="number" [(ngModel)]="roomForm.area" name="area" />
          </div>

          <div class="form-group">
            <label>T·∫ßng *</label>
            <input type="number" [(ngModel)]="roomForm.floor" name="floor" required />
          </div>
        </div>

        <div class="form-group">
          <label>M√¥ t·∫£</label>
          <textarea [(ngModel)]="roomForm.description" name="description" rows="3"></textarea>
        </div>

        <!-- Image Upload Section (Ch·ªâ hi·ªán khi t·∫°o m·ªõi) -->
        <div class="form-group" *ngIf="modalMode === 'create'">
          <label>H√¨nh ·∫£nh ph√≤ng (T·ªëi ƒëa {{ maxImages }} ·∫£nh)</label>
          <input
            type="file"
            accept="image/*"
            multiple
            (change)="onFileSelected($event)"
            #fileInput
            style="display: none"
          />
          <button
            type="button"
            class="btn-upload"
            (click)="fileInput.click()"
            [disabled]="selectedFiles.length >= maxImages"
          >
            üì∑ Ch·ªçn ·∫£nh ({{ selectedFiles.length }}/{{ maxImages }})
          </button>

          <!-- Preview selected images -->
          <div class="image-preview" *ngIf="selectedFiles.length > 0">
            <div *ngFor="let file of selectedFiles; let i = index" class="preview-item">
              <img [src]="getFilePreview(file)" [alt]="file.name" />
              <button type="button" class="btn-remove-preview" (click)="removeSelectedFile(i)">
                ‚úñ
              </button>
              <span class="filename">{{ file.name }}</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Ti·ªán √≠ch</label>
          
          <!-- Predefined Amenities -->
          <div class="predefined-amenities">
            <div *ngFor="let amenity of predefinedAmenities" 
                 class="predefined-amenity"
                 [class.selected]="roomForm.amenities?.includes(amenity)"
                 (click)="toggleAmenity(amenity)">
              {{ amenity }}
            </div>
          </div>
          
          <!-- Custom Amenity Input -->
          <div class="amenities-input">
            <input
              type="text"
              [(ngModel)]="newAmenity"
              name="newAmenity"
              placeholder="Nh·∫≠p ti·ªán √≠ch kh√°c..."
              (keyup.enter)="addAmenityToForm(); $event.preventDefault()"
            />
            <button type="button" (click)="addAmenityToForm()">Th√™m</button>
          </div>
          
          <!-- Selected Amenities -->
          <div class="amenities-list">
            <span *ngFor="let amenity of roomForm.amenities; let i = index" class="amenity-tag">
              {{ amenity }}
              <button type="button" (click)="$event.stopPropagation(); removeAmenityFromForm(i)">‚úñ</button>
            </span>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeModal()">H·ªßy</button>
          <button type="submit" class="btn-submit" [disabled]="loading">
            {{ modalMode === 'create' ? 'T·∫°o Ph√≤ng' : 'C·∫≠p Nh·∫≠t' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
